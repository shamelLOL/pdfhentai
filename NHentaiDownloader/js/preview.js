(()=>{"use strict";var e,t;!function(e){e.cleanName=function(e,n){let a=e.split("").filter((e=>!t.includes(e))).join("");return n?a.trim().replace(/ +/g,"_"):a.trim()},e.getDownloadName=function(e,t,n,a,o,r){e=(e=(e=(e=e.replace(/{pretty}/g,t)).replace(/{english}/g,n)).replace(/{japanese}/g,a)).replace(/{id}/g,o);let l="",i=[],c=[],u=[];return r.forEach((function(e){"group"===e.type?c.push(e.name):"character"===e.type?u.push(e.name):"artist"===e.type?i.push(e.name):"language"===e.type&&"translated"!==e.name&&(l=e.name)})),(e=(e=(e=e.replace(/{group}/g,c.join(", "))).replace(/{character}/g,u.join(", "))).replace(/{artist}/g,i.join(", "))).replace(/{language}/g,l)};let t=["/","\\","?","%","*",":","|",'"',"<",">","."]}(e||(e={})),function(e){e.downloadDone=function(){return'Your file was downloaded, thanks for using NHentai Downloader.<br/><br/><input type="button" id="buttonBack" value="Go Back"/>'},e.downloadProgress=function(e,t,n){return`${e} ${t}, please wait...<br/><progress max="100" id="progressBar" value="${n}"></progress><br/><br/><input type="button" id="buttonBack" value="Cancel"/>`},e.invalidPage=function(){return"This extension must be used on a page containing doujinshi(s) in nhentai.net."},e.errorDownload=function(e){return"An error occured while downloading the doujinshi: <b>"+e+"</b>"},e.errorOther=function(e,t){return`An unexpected error occured (Code ${e}: ${t}).`},e.downloadInfo=function(e,t,n){return'<h3 id="center">'+e+'</h3><div id="center">('+t+' pages)</div><br/><input type="button" id="button" value="Download" autofocus/><br/><br/>Downloads/<input type="text" id="path"/>'+n},e.invalidSyntax=function(){return"Invalid page syntax, each number must be separated by a comma ',' or a dash '-'"},e.invalidPageNumber=function(e){return"Page number must be between 0 and "+e},e.invalidBounds=function(){return"Upper limit must be strictly bigger than lower limit"}}(t||(t={}));var n,a,o,r,l,i,c=function(e,t,n,a){return new(n||(n=Promise))((function(o,r){function l(e){try{c(a.next(e))}catch(e){r(e)}}function i(e){try{c(a.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,i)}c((a=a.apply(e,t||[])).next())}))},u=function(e,t,n,a){if("a"===n&&!a)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?a:"a"===n?a.call(e):a?a.value:t.get(e)};class d{constructor(){n.add(this),this.parsing=null}static getInstance(){return null===u(d,a,"f",o)&&function(e,t,n,a,o){if("m"===a)throw new TypeError("Private method is not writable");if("a"===a&&!o)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!o:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");"a"===a?o.call(e,n):o?o.value=n:t.set(e,n)}(d,a,new d,"f",o),u(d,a,"f",o)}updateProgress(e,n,a){document.getElementById("action").innerHTML=a&&100==e?t.downloadDone():t.downloadProgress(a?"Zipping":"Downloading",n,e),document.getElementById("buttonBack").addEventListener("click",(function(){let e=d.getInstance();chrome.extension.getBackgroundPage().goBack(),e.updatePreviewAsync(e.url)}))}updatePreviewAsync(e){return c(this,void 0,void 0,(function*(){let a=d.getInstance();a.url=e;let o=/https:\/\/nhentai.net\/g\/([0-9]+)\/([/0-9a-z]+)?/.exec(a.url);null!==o?yield u(a,n,"m",r).call(a,o[1]):a.url.startsWith("https://nhentai.net")?chrome.tabs.executeScript(null,{file:"js/getHtml.js"}):document.getElementById("action").innerHTML=t.invalidPage()}))}updatePreviewAll(a,o,r,c){let s,g=d.getInstance(),p=/<a href="\/g\/([0-9]+)\/".+<div class="caption">([^<]+)((<br>)+<input [^>]+>[^<]+<br>[^<]+<br>[^<]+)?<\/div>/g,m="",h=[],f=0,y=a.replace(/<\/a>/g,"\n");do{if(s=p.exec(y),null!==s){let e,t=!1;if(void 0!==s[4]){var w=y.match('<input id="'+s[1]+'" type="checkbox"( value="(true|false)")?>');try{t="true"===w[2]}catch(e){t=!1}}e="{pretty}"===o?s[2].replace(/\[[^\]]+\]/g,"").replace(/\([^\)]+\)/g,"").replace(/\{[^\}]+\}/g,"").trim():s[2].trim(),m+='<input id="'+s[1]+'" name="'+e+'" type="checkbox" '+(t?"checked":"")+"/>"+e+"<br/>",h.push(s[1]),f++}}while(s);if(""===m)return void(document.getElementById("action").innerHTML=t.invalidPage());let v,b=g.url.split("/");v=""===b[b.length-1]||b[b.length-1].startsWith("?page=")?b[b.length-2]:b[b.length-1],v=v.replace("q=","");let I="";"raw"!=r&&(I="."+r);let E=0,B=0,P=0,k='<h3 id="center">'+f+" doujinshi"+(f>1?"s":"")+" found</h3>"+m+'<input type="button" id="invert" value="Invert all"/><input type="button" id="remove" value="Clear all"/><br/><br/><input type="button" id="button" value="Download"/>',x=/page=([0-9]+)" class="last">/.exec(y);null!==x&&(B=parseInt(/page=([0-9]+)" class="page current">/.exec(y)[1]),P=parseInt(x[1]),E=P-B+1,k+='<br/><input type="button" id="buttonAll" value="Download all ('+E+' pages)"/><br/><input type="text" id="downloadInput"/><input type="button" id="buttonHelp" value="?"/>'),k+='<br/><br/>Downloads/<input type="text" id="path"/>'+I,document.getElementById("action").innerHTML=k,document.getElementById("path").value=e.cleanName(v,c),null!==x&&(document.getElementById("downloadInput").value=B+"-"+P,document.getElementById("buttonHelp").addEventListener("click",(function(){alert("Input the pages you want to download for the \"Download all\" feature\nWrite your pages separated by comma ',', you can also write range of number by separating them by a dash '-'\nExample: 2,4,6-10 will download the pages 2, 4 and 6 to 10 (included)")}))),document.getElementById("invert").addEventListener("click",(function(){let e;chrome.storage.local.get({allIds:[]},(function(t){e=t.allIds;for(let t=0;t<h.length;t++){let a=h[t],o=document.getElementById(a);o.checked=!o.checked,e=u(g,n,"m",l).call(g,a,e,o.checked)}chrome.storage.local.set({allIds:e}),chrome.tabs.executeScript(null,{file:"js/updateContent.js"})}))})),document.getElementById("remove").addEventListener("click",(function(){h.forEach((function(e){document.getElementById(e).checked=!1})),chrome.storage.local.set({allIds:[]}),chrome.tabs.executeScript(null,{file:"js/updateContent.js"})})),document.getElementById("button").addEventListener("click",(function(){let e={};if(h.forEach((function(t){let n=document.getElementById(t);n.checked&&(e[t]=n.name)})),Object.keys(e).length>0){let n=document.getElementById("path").value;chrome.extension.getBackgroundPage().downloadAllDoujinshis(e,n,(function(e){document.getElementById("action").innerHTML=t.errorDownload(e)}),d.getInstance().updateProgress),g.updateProgress(0,n,!1)}else document.getElementById("action").innerHTML="You must select at least one element to download."})),E>0&&(document.getElementById("downloadInput").addEventListener("change",(function(){let e=u(g,n,"m",i).call(g,P);0!==e.length&&(document.getElementById("buttonAll").value="Download all ("+e.length+" pages)")})),document.getElementById("buttonAll").addEventListener("click",(function(){let e={};h.forEach((function(t){let n=document.getElementById(t);e[t]=n.name}));let t=u(g,n,"m",i).call(g,P);if("string"==typeof t)alert(t),document.getElementById("downloadInput").value=B+"-"+E;else if(confirm("You are going to download "+t.length+" pages of doujinshi. Are you sure you want to continue?")){let n=document.getElementById("path").value;chrome.extension.getBackgroundPage().downloadAllPages(e,t,n,(function(e){document.getElementById("action").innerHTML="An error occured while downloading the doujinshi: <b>"+e+"</b>"}),g.updateProgress,g.url),g.updateProgress(0,n,!1)}}))),h.forEach((function(e){document.getElementById(e).addEventListener("change",(function(){let t=this.checked;chrome.storage.local.get({allIds:[]},(function(a){chrome.storage.local.set({allIds:u(g,n,"m",l).call(g,e,a.allIds,t)})})),chrome.tabs.executeScript(null,{file:"js/updateContent.js"})})),chrome.storage.local.get({allIds:[]},(function(t){t.allIds.includes(e)&&(document.getElementById(e).checked=!0)}))}))}}a=d,n=new WeakSet,r=function(n){return c(this,void 0,void 0,(function*(){const a=yield fetch(this.parsing.GetUrl(n));if(403==a.status)document.getElementById("action").innerHTML=t.invalidPage();else if(a.ok){let o=yield this.parsing.GetJsonAsync(a),r=this;chrome.storage.sync.get({useZip:"zip",downloadName:"{pretty}",replaceSpaces:!0},(function(a){let l="";"zip"==a.useZip?l=".zip":"cbz"==a.useZip&&(l=".cbz");let i=e.getDownloadName(a.downloadName,""===o.title.pretty?o.title.english.replace(/\[[^\]]+\]/g,"").replace(/\([^\)]+\)/g,""):o.title.pretty,o.title.english,o.title.japanese,n,o.tags);document.getElementById("action").innerHTML=t.downloadInfo(i,o.images.pages.length,l),document.getElementById("path").value=e.cleanName(i,a.replaceSpaces),document.getElementById("button").addEventListener("click",(function(){chrome.extension.getBackgroundPage().downloadDoujinshi(o,document.getElementById("path").value,(function(e){document.getElementById("action").innerHTML=t.errorDownload(e)}),r.updateProgress,i),r.updateProgress(0,i,!1)}))}))}else document.getElementById("action").innerHTML=t.errorOther(a.status,a.statusText)}))},l=function(e,t,n){if(n)t.push(e);else{let n=t.indexOf(e);-1!==n&&t.splice(n,1)}return t},i=function(e){let n=[];return document.getElementById("downloadInput").value.split(",").forEach((function(a){let o=a.trim(),r=o.split("-");if(r.length>1){let a=r[0].trim(),o=r[1].trim(),l=parseInt(a),i=parseInt(o);if(a!==""+l||o!==""+i)return t.invalidSyntax();if(l<0||i<0||l>e||i>e)return t.invalidPageNumber(e);if(i<=l)return t.invalidBounds();for(let e=l;e<=i;e++)n.includes(e)||n.push(e)}else{let a=parseInt(o);if(o!==""+a)return t.invalidSyntax();if(a<0||a>e)return t.invalidPageNumber(e);n.includes(a)||n.push(a)}})),n},o={value:null};class s{GetUrl(e){return"https://nhentai.net/api/gallery/"+e}GetJsonAsync(e){return e.json()}}class g{GetUrl(e){return"https://nhentai.net/g/"+e+"/1/"}GetJsonAsync(e){return e.text().then((e=>JSON.parse(e.split('window._gallery = JSON.parse("')[1].split('");')[0].replace(/\\u[\dA-F]{4}/gi,(function(e){return String.fromCharCode(parseInt(e.replace(/\\u/g,""),16))})))))}}let p=d.getInstance();chrome.tabs.query({active:!0,currentWindow:!0},(function(e){chrome.storage.sync.get({darkMode:!1,htmlParsing:!1},(function(t){null===p.parsing&&(p.parsing=t.htmlParsing?new g:new s),t.darkMode&&(document.getElementById("htmlLight").id="htmlDark");let n=e[0].url;p.url=n,chrome.storage.local.get({lastUrl:""},(function(e){e.lastUrl!==n&&(chrome.storage.local.clear(),chrome.storage.local.set({lastUrl:n})),chrome.extension.getBackgroundPage().isDownloadFinished()?p.updatePreviewAsync(n):chrome.extension.getBackgroundPage().updateProgress(p.updateProgress)}))}))})),chrome.runtime.onMessage.addListener((function(e,t){"getHtml"==e.action&&chrome.storage.sync.get({useZip:"zip",downloadName:"{pretty}",replaceSpaces:!0},(function(t){p.updatePreviewAll(e.source,t.downloadName,t.useZip,t.replaceSpaces)}))}))})();